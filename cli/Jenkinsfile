pipeline {
    agent any
    
    parameters {
        string(name: 'BRANCH', defaultValue: 'main', description: 'Branch name to build')
    }
    
        environment {
        WHEELHOUSE_PATH = 'C:/deploys/packages/wheelhouse'
        CLI_PATH = "${WORKSPACE}/cli"
        PYTHONPATH = "${CLI_PATH}"
        PATH = "${env.PATH};${CLI_PATH}/scripts"
        PYTHONIOENCODING = 'UTF-8'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                script {
                    def branchName = params.BRANCH ?: env.BRANCH_NAME ?: 'unknown'
                    echo "ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ - ë¸Œëœì¹˜: ${branchName}"
                }
            }
        }
        
        stage('Setup Python Environment') {
            steps {
                dir('cli') {
                    script {
                        echo "Setting up Python environment for CLI"
                        
                        // Windowsì—ì„œ ê°€ìƒí™˜ê²½ ìƒì„± ë° í™œì„±í™”
                        bat """
                            if exist .venv rmdir /s /q .venv
                            "%LOCALAPPDATA%\\Programs\\Python\\Launcher\\py.exe" -3.13 -m venv .venv
                            call .venv\\Scripts\\activate.bat
                            python -m pip install --upgrade pip
                        """
                        
                        // ì˜ì¡´ì„± ì„¤ì¹˜ (wheelhouse ìš°ì„  ì‚¬ìš©)
                        script {
                            def wheelHouseExists = bat(
                                script: "if exist \"${env.WHEELHOUSE_PATH}\\*.whl\" echo found",
                                returnStdout: true
                            ).contains('found')
                            
                            if (wheelHouseExists) {
                                echo "íœ í•˜ìš°ìŠ¤ ë°œê²¬ - ì˜¤í”„ë¼ì¸ ê³ ì† ì„¤ì¹˜ ëª¨ë“œ"
                                bat """
                                    call .venv\\Scripts\\activate.bat
                                    pip install --no-index --find-links="${env.WHEELHOUSE_PATH}" -r requirements-dev.txt
                                    pip install --no-index --find-links="${env.WHEELHOUSE_PATH}" .
                                """
                            } else {
                                echo "íœ í•˜ìš°ìŠ¤ ì—†ìŒ - ì˜¨ë¼ì¸ ì„¤ì¹˜ ëª¨ë“œ"
                                bat """
                                    call .venv\\Scripts\\activate.bat
                                    pip install -r requirements-dev.txt
                                    pip install .
                                """
                            }
                        }
                    }
                }
            }
        }
        
        stage('Run Tests') {
            steps {
                dir('cli') {
                    script {
                        echo "Running CLI tests"
                        
                        bat """
                            call .venv\\Scripts\\activate.bat
                            set PYTHONPATH=${CLI_PATH}\\src
                            
                            REM í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë””ë ‰í† ë¦¬ ìƒì„±
                            if not exist test-results mkdir test-results
                            
                            REM í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
                            pytest tests\\unit\\ -v --junit-xml=test-results\\junit-unit.xml --cov=ts_cli --cov-report=html || echo "Unit tests completed with issues"
                            pytest tests\\integration\\ -v --junit-xml=test-results\\junit-integration.xml || echo "Integration tests completed with issues"
                        """
                    }
                }
            }
            post {
                always {
                    script {
                        if (fileExists('cli/test-results/junit-unit.xml')) {
                            junit 'cli/test-results/junit-unit.xml'
                        }
                        if (fileExists('cli/test-results/junit-integration.xml')) {
                            junit 'cli/test-results/junit-integration.xml'
                        }
                        if (fileExists('cli/htmlcov/index.html')) {
                            publishHTML([
                                allowMissing: false,
                                alwaysLinkToLastBuild: true,
                                keepAll: true,
                                reportDir: 'cli/htmlcov',
                                reportFiles: 'index.html',
                                reportName: 'Coverage Report'
                            ])
                        }
                    }
                }
            }
        }
        
        stage('Build Executable') {
            steps {
                dir('cli') {
                    script {
                        echo "Building executable with PyInstaller"
                        
                        // PyInstallerë¡œ ì‹¤í–‰ íŒŒì¼ ìƒì„±
                        bat """
                            call .venv\\Scripts\\activate.bat
                            set PYTHONPATH=${CLI_PATH}\\src
                            python scripts\\build.py
                        """
                        
                        // ë¹Œë“œ ê²°ê³¼ í™•ì¸
                        bat """
                            if exist dist\\windows\\ts-cli.exe (
                                echo "Build successful: ts-cli.exe created"
                                dir dist\\windows\\ts-cli.exe
                            ) else (
                                echo "Build failed: ts-cli.exe not found"
                                exit 1
                            )
                        """
                    }
                }
            }
        }
        
        stage('Create Installer') {
            steps {
                dir('cli') {
                    script {
                        echo "Creating NSIS installer"
                        
                        // NSIS ì„¤ì¹˜íŒŒì¼ ìƒì„±
                        bat """
                            makensis scripts\\setup_win.nsi
                        """
                        
                        // ì„¤ì¹˜íŒŒì¼ í™•ì¸
                        bat """
                            if exist dist\\TestscenarioMaker-CLI-Setup.exe (
                                echo "Installer created successfully"
                                dir dist\\TestscenarioMaker-CLI-Setup.exe
                            ) else (
                                echo "Installer creation failed"
                                exit 1
                            )
                        """
                    }
                }
            }
        }
        
        stage('Rename and Archive') {
            steps {
                dir('cli') {
                    script {
                        echo "Renaming installer with branch name: ${params.BRANCH}"
                        
                        // ë¸Œëœì¹˜ëª…ì„ íŒŒì¼ëª…ì— ì¶”ê°€ (íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬)
                        def branchSuffix = params.BRANCH.replaceAll('/', '-').replaceAll('\\\\', '-')
                        def originalName = "TestscenarioMaker-CLI-Setup.exe"
                        def newName = "TestscenarioMaker-CLI-Setup-${branchSuffix}.exe"
                        
                        bat """
                            cd dist
                            if exist "${originalName}" (
                                move /Y "${originalName}" "${newName}"
                                echo "Renamed to ${newName}"
                                dir "${newName}"
                            ) else (
                                echo "Original installer not found"
                                exit 1
                            )
                        """
                        
                        // ì•„í‹°íŒ©íŠ¸ ë“±ë¡
                        archiveArtifacts artifacts: "dist/${newName}", 
                                        fingerprint: true,
                                        allowEmptyArchive: false
                        
                        // ì‹¤í–‰íŒŒì¼ë„ ì•„í‹°íŒ©íŠ¸ë¡œ ë“±ë¡
                        archiveArtifacts artifacts: "dist/windows/ts-cli.exe",
                                        fingerprint: true,
                                        allowEmptyArchive: false
                        
                        echo "Artifacts archived successfully"
                    }
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                script {
                    echo "Cleaning up workspace"
                    
                    // ë¹Œë“œ ë””ë ‰í† ë¦¬ ì •ë¦¬ (ì„ íƒì )
                    bat """
                        cd cli
                        if exist build rmdir /S /Q build 2>nul || echo "No build directory to clean"
                        if exist ts_cli.egg-info rmdir /S /Q ts_cli.egg-info 2>nul || echo "No egg-info to clean"
                        if exist .pytest_cache rmdir /S /Q .pytest_cache 2>nul || echo "No pytest cache to clean"
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo "âœ… CLI build completed successfully for branch: ${params.BRANCH}"
            
            script {
                def branchSuffix = params.BRANCH.replaceAll('/', '-').replaceAll('\\\\', '-')
                def installerName = "TestscenarioMaker-CLI-Setup-${branchSuffix}.exe"
                
                echo "ğŸ“¦ Generated artifacts:"
                echo "  - Installer: ${installerName}"
                echo "  - Executable: ts-cli.exe"
                echo "  - Coverage report available in HTML format"
            }
            
            // Slack ë˜ëŠ” ì´ë©”ì¼ ì•Œë¦¼ (í•„ìš”ì‹œ í™œì„±í™”)
            // slackSend(channel: '#builds', message: "âœ… CLI build successful: ${params.BRANCH}")
        }
        
        failure {
            echo "âŒ CLI build failed for branch: ${params.BRANCH}"
            
            script {
                echo "Build failure detected. Check logs for details."
                echo "Common issues:"
                echo "  - Python environment setup failure"
                echo "  - Test failures"
                echo "  - PyInstaller build issues"
                echo "  - NSIS installer creation problems"
            }
            
            // ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
            // slackSend(channel: '#builds', message: "âŒ CLI build failed: ${params.BRANCH}", color: 'danger')
        }
        
        always {
            script {
                echo "Pipeline execution completed"
                
                // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë° ì»¤ë²„ë¦¬ì§€ ë³´ê³ ì„œ ìˆ˜ì§‘
                if (fileExists('cli/test-results')) {
                    echo "ğŸ“Š Test results collected"
                }
                if (fileExists('cli/htmlcov')) {
                    echo "ğŸ“ˆ Coverage report generated"
                }
                
                // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒíƒœ í™•ì¸
                bat """
                    cd cli
                    if exist dist\\windows\\ts-cli.exe echo "âœ“ Executable preserved"
                    if exist dist\\TestscenarioMaker-CLI-Setup-*.exe echo "âœ“ Installer preserved"
                """
            }
        }
    }
}